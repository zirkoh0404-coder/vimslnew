<%- include('partials/navbar') %>

<style>
    @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    .animate-conveyor { display: flex; animation: scroll 30s linear infinite; width: max-content; }
    .animate-conveyor:hover { animation-play-state: paused; }
    
    @keyframes levitate {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
    }

    .player-card { 
        transition: transform 0.1s ease-out, box-shadow 0.3s ease, border-color 0.3s ease;
        cursor: pointer; 
        position: relative;
        overflow: hidden;
        transform-style: preserve-3d;
        perspective: 1000px;
        animation: levitate 4s ease-in-out infinite;
        background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
        border: 1px solid rgba(255,255,255,0.05);
    }
    
    .player-card:hover { 
        z-index: 10; 
        border-color: #3b82f6; 
        box-shadow: 0 25px 50px -12px rgba(59, 130, 246, 0.5);
        animation-play-state: paused;
    }

    /* FALLBACK DESIGN STYLING */
    .headshot-container {
        position: relative;
        width: 110px;
        height: 110px;
        margin-top: 20px;
        z-index: 2;
    }

    .headshot-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 3px solid #3b82f6;
        padding: 4px;
        background: rgba(0,0,0,0.3);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        transition: transform 0.3s ease;
    }

    .player-card:hover .headshot-circle {
        transform: scale(1.1);
    }

    .card-active-anim {
        animation: sleekClick 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        pointer-events: none;
    }

    @keyframes sleekClick {
        0% { transform: scale(1); box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
        50% { transform: scale(1.08); box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
        100% { transform: scale(1.02); opacity: 0.8; }
    }

    .modal { 
        display: none; 
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px; 
        backdrop-filter: blur(0px);
        transition: all 0.4s ease;
    }
    
    .modal.active { background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); }

    #modalContainer {
        transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
        transform: translateY(50px) scale(0.95);
        opacity: 0;
    }

    #modalContainer.show {
        transform: translateY(0) scale(1);
        opacity: 1;
    }

    .stat-badge {
        background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
        border: 1px solid rgba(255,255,255,0.05);
    }

    .form-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 1.2rem; border-radius: 1.2rem; outline: none; transition: 0.3s; color: white; font-style: italic; }
    .form-input:focus { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
    
    .hidden-form { display: none !important; }

    .rating-badge {
        background: #3b82f6;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
    }
</style>

<% if (typeof error !== 'undefined' && error) { %>
    <div class="fixed top-24 left-1/2 -translate-x-1/2 z-[110] bg-red-600 text-white px-10 py-5 rounded-[30px] font-black uppercase italic shadow-[0_20px_50px_rgba(220,38,38,0.5)] border-2 border-white/20 animate-bounce">
        ⚠️ <%= error %>
    </div>
<% } %>

<main class="py-24 overflow-hidden bg-[#020617] min-h-screen">
    <div class="max-w-7xl mx-auto px-6 mb-16 flex justify-between items-end">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <div class="h-[2px] w-8 bg-blue-500"></div>
                <span class="text-blue-500 font-black tracking-[0.4em] text-[10px] uppercase">VIM Season 2026</span>
            </div>
            <h2 class="text-6xl font-black italic uppercase tracking-tighter text-white">PLAYER <span class="text-blue-600">MARKET</span></h2>
        </div>
        <div class="bg-blue-600/5 border border-blue-500/20 px-6 py-3 rounded-full backdrop-blur-xl">
            <span class="text-[11px] text-blue-400 font-black uppercase tracking-widest">● LIVE SCOUTING: <%= players.length %> PLAYERS</span>
        </div>
    </div>

    <% if(players.length > 0) { %>
        <div class="relative flex items-center mb-40 border-y border-white/5 py-16 bg-gradient-to-b from-blue-900/5 to-transparent">
            <div class="animate-conveyor gap-12 px-6">
                <% let displayList = players.length < 5 ? [...players, ...players, ...players, ...players] : [...players, ...players]; %>
                <% displayList.forEach(p => { 
                    let cleanName = (p.name || 'Unknown').trim();
                    let rating = p.rating || 60;
                    // Updated Roblox Headshot Fetch Logic
                    let robloxHeadshot = `https://www.roblox.com/headshot-thumbnail/image?userName=${encodeURIComponent(cleanName)}&width=150&height=150&format=png`;
                    
                    let hasCustomImage = (p.cardImage && p.cardImage !== 'none' && p.cardImage !== '');
                %>
                    <div class="player-card w-[260px] h-[360px] rounded-[35px] flex-shrink-0 relative group flex flex-col items-center"
                         onmousemove="tiltCard(event, this)" 
                         onmouseleave="resetTilt(this)"
                         onclick="openBio(this, '<%= cleanName %>', '<%= hasCustomImage ? p.cardImage : robloxHeadshot %>', `<%= (p.experience || p.bio || 'No bio').replace(/`/g, '\\`') %>`, '<%= p.discord %>', '<%= p.goals || 0 %>', '<%= p.assists || 0 %>', '<%= p.saves || 0 %>', '<%= p.mvps || 0 %>', '<%= p.views ? p.views.length : 0 %>', '<%= p.position %>', '<%= p.country %>', '<%= p.timezone %>', '<%= rating %>')">
                        
                        <% if (hasCustomImage) { %>
                            <img src="<%= p.cardImage %>" class="w-full h-full object-cover rounded-[35px]" onerror="this.src='<%= robloxHeadshot %>'">
                        <% } else { %>
                            <div class="absolute top-6 left-6 z-10">
                                <div class="rating-badge w-11 h-11 rounded-full flex items-center justify-center border border-white/20">
                                    <span class="text-white font-black text-xl italic"><%= rating %></span>
                                </div>
                            </div>
                            <div class="headshot-container">
                                <img src="<%= robloxHeadshot %>" class="headshot-circle object-cover" loading="lazy">
                            </div>
                            <div class="text-center mt-6 px-4">
                                <span class="text-[9px] font-black text-blue-500/60 uppercase tracking-[0.3em] mb-1 block"><%= p.country || 'GLOBAL' %></span>
                                <h3 class="font-black text-2xl italic uppercase tracking-tighter text-white leading-tight"><%= cleanName %></h3>
                            </div>
                            <div class="mt-auto mb-8 flex gap-4 opacity-40 group-hover:opacity-100 transition-all">
                                <div class="text-center"><p class="text-[8px] font-black text-white/50 uppercase">G</p><p class="text-xs font-bold text-white"><%= p.goals || 0 %></p></div>
                                <div class="text-center"><p class="text-[8px] font-black text-white/50 uppercase">A</p><p class="text-xs font-bold text-white"><%= p.assists || 0 %></p></div>
                                <div class="text-center"><p class="text-[8px] font-black text-white/50 uppercase">MVP</p><p class="text-xs font-bold text-blue-500"><%= p.mvps || 0 %></p></div>
                            </div>
                        <% } %>
                    </div>
                <% }) %>
            </div>
        </div>
    <% } %>

    <div id="bioModal" class="modal" onclick="closeBio()">
        <div class="max-w-4xl w-full flex flex-col md:flex-row gap-8 items-stretch relative p-4" id="modalContainer" onclick="event.stopPropagation()">
            <div class="md:w-1/3 bg-[#0a0f1e] rounded-[40px] border border-white/10 p-8 flex flex-col items-center justify-center relative overflow-hidden shadow-2xl">
                <div class="absolute top-[-20%] right-[-20%] w-64 h-64 bg-blue-600/10 blur-[100px] rounded-full"></div>
                <div class="relative z-10 w-32 h-32 rounded-full border-4 border-blue-600 p-2 mb-6">
                    <img id="modalImg" src="" class="w-full h-full rounded-full object-cover shadow-2xl">
                </div>
                <div class="relative z-10 text-center">
                    <div id="modalRating" class="text-5xl font-black italic text-blue-500 mb-2">60</div>
                    <h2 id="modalName" class="text-3xl font-black italic uppercase text-white tracking-tighter mb-4"></h2>
                    <div id="modalPosBadge" class="inline-block bg-blue-600 text-white text-[10px] font-black px-4 py-1.5 rounded-full italic uppercase tracking-widest"></div>
                </div>
            </div>
            <div class="flex-1 bg-white/5 backdrop-blur-3xl p-10 rounded-[40px] border border-white/10 shadow-2xl relative">
                <div class="flex justify-between items-start mb-10">
                    <div>
                        <p id="modalDiscord" class="text-blue-400 font-bold text-sm uppercase tracking-widest mb-1"></p>
                        <p id="modalTZ" class="text-[10px] text-white/40 font-black uppercase italic"></p>
                    </div>
                    <div class="text-right">
                        <p id="modalViews" class="text-4xl font-black italic text-white leading-none">0</p>
                        <p class="text-[8px] uppercase font-black text-blue-500 tracking-[0.2em] mt-1">TOTAL VIEWS</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
                    <div class="stat-badge p-5 rounded-3xl text-center"><p class="text-[9px] uppercase font-black text-white/30 mb-1">Goals</p><p id="mGoals" class="text-3xl font-black italic text-white">0</p></div>
                    <div class="stat-badge p-5 rounded-3xl text-center"><p class="text-[9px] uppercase font-black text-white/30 mb-1">Assists</p><p id="mAssists" class="text-3xl font-black italic text-white">0</p></div>
                    <div class="stat-badge p-5 rounded-3xl text-center"><p class="text-[9px] uppercase font-black text-white/30 mb-1">Saves</p><p id="mSaves" class="text-3xl font-black italic text-white">0</p></div>
                    <div class="stat-badge p-5 rounded-3xl text-center border-blue-600/40 bg-blue-600/10"><p class="text-[9px] uppercase font-black text-blue-400 mb-1">MVP</p><p id="mMvps" class="text-3xl font-black italic text-blue-500">0</p></div>
                </div>
                <div class="space-y-4">
                    <p class="text-[10px] uppercase tracking-[0.4em] text-white/30 font-black">Contract Biography</p>
                    <div id="modalBio" class="text-gray-300 leading-relaxed text-sm h-32 overflow-y-auto pr-6 italic scrollbar-hide bg-black/20 p-6 rounded-3xl border border-white/5"></div>
                </div>
                <button onclick="closeBio()" class="mt-8 w-full bg-white text-black hover:bg-blue-600 hover:text-white py-4 rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] transition-all duration-500">Back to Market</button>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto px-6 mt-20">
        <% if (user) { %>
            <div class="max-w-xl mx-auto bg-gradient-to-br from-white/10 to-transparent p-12 rounded-[50px] border border-white/10 text-center">
                <h3 class="text-2xl font-black italic uppercase text-white mb-2">Authenticated: <span class="text-blue-500"><%= user.name %></span></h3>
                <a href="/profile" class="block w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-[11px] uppercase tracking-widest mt-6">Access Player Dashboard</a>
            </div>
        <% } else { %>
            <div class="grid md:grid-cols-1 max-w-2xl mx-auto gap-10">
                <div id="registerBox" class="bg-white/5 p-12 rounded-[50px] border border-white/10">
                    <h3 class="text-3xl font-black italic mb-8 uppercase text-white">Join the Market</h3>
                    <form action="/register" method="POST" class="space-y-5">
                        <div class="grid grid-cols-2 gap-5">
                            <input name="name" placeholder="ROBLOX USERNAME" required class="form-input">
                            <input name="discord" placeholder="DISCORD USERNAME" required class="form-input">
                        </div>
                        <textarea name="experience" placeholder="PLAYER BIOGRAPHY..." required class="form-input h-32"></textarea>
                        <input type="password" name="password" placeholder="SECURE PASSWORD" required class="form-input">
                        <button type="submit" class="w-full bg-white text-black py-5 rounded-2xl font-black text-[11px] uppercase">Submit Contract</button>
                    </form>
                    <button onclick="toggleAuth()" class="mt-6 text-[10px] font-black uppercase text-white/30">Switch to Login</button>
                </div>
                <div id="loginBox" class="bg-white/5 p-12 rounded-[50px] border border-white/10 hidden-form">
                    <h3 class="text-3xl font-black italic mb-8 uppercase text-blue-500">Player Portal</h3>
                    <form action="/login" method="POST" class="space-y-6">
                        <input name="username" placeholder="ROBLOX USERNAME" required class="form-input">
                        <input type="password" name="password" placeholder="ACCOUNT PASSWORD" required class="form-input">
                        <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-[11px] uppercase">Authorize Access</button>
                    </form>
                    <button onclick="toggleAuth()" class="mt-6 text-[10px] font-black uppercase text-white/30">Need a Listing? Register</button>
                </div>
            </div>
        <% } %>
    </div>
</main>

<script>
    function toggleAuth() {
        const reg = document.getElementById('registerBox');
        const log = document.getElementById('loginBox');
        reg.classList.toggle('hidden-form');
        log.classList.toggle('hidden-form');
    }

    function tiltCard(e, el) {
        const rect = el.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const xc = rect.width / 2;
        const yc = rect.height / 2;
        const dx = (x - xc) / xc;
        const dy = (y - yc) / yc;
        el.style.transform = `rotateY(${dx * 20}deg) rotateX(${-dy * 20}deg) scale(1.05)`;
    }

    function resetTilt(el) {
        el.style.transform = `rotateY(0deg) rotateX(0deg) scale(1)`;
    }

    async function openBio(el, name, img, bio, discord, g, a, s, m, currentViews, pos, country, tz, rating) {
        el.classList.add('card-active-anim');
        document.getElementById('modalName').innerText = name;
        document.getElementById('modalBio').innerText = bio;
        document.getElementById('modalDiscord').innerText = "@" + discord;
        document.getElementById('modalRating').innerText = rating;
        document.getElementById('modalImg').src = img;
        document.getElementById('modalPosBadge').innerText = pos || 'PLAYER';
        document.getElementById('modalTZ').innerText = "LOCATION: " + (country || 'N/A') + " | " + (tz || 'UTC');
        document.getElementById('mGoals').innerText = g;
        document.getElementById('mAssists').innerText = a;
        document.getElementById('mSaves').innerText = s;
        document.getElementById('mMvps').innerText = m;
        document.getElementById('modalViews').innerText = currentViews;
        
        try {
            const res = await fetch(`/market/view/${encodeURIComponent(name)}`, { method: 'POST' });
            const data = await res.json();
            if(data.success) document.getElementById('modalViews').innerText = data.count;
        } catch(e) {}
        
        setTimeout(() => {
            const modal = document.getElementById('bioModal');
            const container = document.getElementById('modalContainer');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('active');
                container.classList.add('show');
                el.classList.remove('card-active-anim');
            }, 50);
        }, 300);
    }

    function closeBio() { 
        const modal = document.getElementById('bioModal');
        const container = document.getElementById('modalContainer');
        container.classList.remove('show');
        modal.classList.remove('active');
        setTimeout(() => { modal.style.display = 'none'; }, 400);
    }
</script>
